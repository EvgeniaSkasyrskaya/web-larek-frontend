# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемые в приложении

Данные товара
```
interface IItem {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number | null;
    isInBasket: boolean;
    index: number;
}
```
Данные о товарах, выбранных покупателем (корзина покупок)
```
interface IBasket {
    items: string[];
    total: number;
}
```
Данные о доставке и оплате товаров
```
interface IDeliveryInfo {
    address: string;
    payment: string;
}
```
Контактные данные покупателя
```
interface IContacts {
    email: string;
    phone: string;
}
```
Информация о заказе 
```
type IOrder = IDeliveryInfo & IContacts & IBasket
```

Интерфейс модели данных 
```
interface IAppState {
    catalog: IItem[];
    preview: string | null;
    order: IOrder;     
}
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP: 
- слой данных, отвечает за хранение и изменение данных,
- слой представления, отвечает за отображение данных на странице, 
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов.\ 
Класс имеет следующие поля:
- baseUrl: string - базовый адрес сервера
- options: RequestInit - опциональный объект с заголовками запросов,\
которые передаются  в конструктор:\
- constructor(baseUrl: string, options: RequestInit = {})\
Методы: 
- get(uri: string): Promise - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- post(uri: string, data: object, method: ApiPostMethods = 'POST'): Promise - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт, переданный как параметр при вызове метода. По умолчанию выполняется POST-запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове
- handleResponse(response: Response): Promise<object> - обрабатывает ответ сервера, если ответ имеет статус ok, то применяет к нему метод json, возвращая промис с результатом запроса, в противном случае возвращает промис с информацией об ошибке

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.\
Поля класса:
- events: Map<EventName, Set<Subscriber>> (type EventName = string | RegExp, type Subscriber = Function).\
Значение этого поля устанавливается в конструкторе через создание экземпляра объекта Map. Параметры конструктор не принимает.\
Основные методы, реализуемые классом описаны интерфейсом IEvents:
- on<T>(event: EventName, callback: (data: T) => void): void - подписывает на событие
- off(eventName: EventName, callback: Subscriber): void - отменяет подписку на событие
- emit<T>(event: string, data?: T): void - инициирует событие
- onAll(callback: (event: EmitterEvent) => void): void - подписывает на все события
- offAll(): void - отменяет подписки на все события
- trigger<T>(event: string, context?: Partial<T>): (data: T) => void - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие. Это позволяет передавать его в качестве обработчика события в другие классы. 

### Слой данных

#### Класс AppState
Класс отвечает за хранение информации о товарах и данных пользователя, а также за логику работы с данными о товарах, выбранных пользователем для покупки. Конструктор класса принимает инстант брокера событий:
- constructor(events: IEvents) \
В полях класса хранятся следующие данные:
- catalog: IItem[] - массив объектов с информацией о товарах
- preview: string | null - id товара, выбранного для просмотра в модальном окне
- order: IOrder | null - объект с информацией о заказе, содержащий данные покупателя и массив строк с id товаров, выбранных пользователем для покупки/

Также класс предоставляет набор методов для взаимодействия с этими данными:
- setCatalog(items: IItem[]): void - сохраняет в классе массив данных о товарах
- getItem(id: string): IItem - возвращает объект товара (IItem) по его id
- isItemInBasket(id: string): boolean - проверяет, находится ли товар с данным id в корзине покупок 
- setPreview(id: string): void - сохраняет значение id товара, выбранного пользователем для просмотра в модальном окне
- addBasketItem(id: string): void - добавляет id выбранного товара в корзину (массив строк, сохраненный в поле basket)
- deleteBasketItem(id: string): void - удаляет id выбранного товара из корзины (массива строк, сохраненного в поле basket)
- setTotalCost(): void - рассчитывает общую стоимость товаров в корзине
- clearOrderInfo(): void - очищает корзину и данные покупателя
- setPayMethod(value: string): void - сохраняет в классе информацию о способе оплаты, который выбирается с помощью кнопок в форме заказа
- setDeliveryFormField(field: keyof IDeliveryInfo, value: string) - сохраняет в классе значение поля ввода в форме заказа
- setContactsFormField(field: keyof IContacts, value: string) - сохраняет в классе значение поля ввода в форме данных пользователя
- validateDeliveryInfo(): void - метод используется внутри класса для определения валидности заполнения данных о заказе
- validateContactsnfo(): void - метод используется внутри класса для определения валидности заполнения контактных данных покупателя


### Слой представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс Component
Класс является дженериком и родителем всех компонентов слоя представления. Дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. Конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента:
- constructor(container: HTMLElement) \
Класс предоставляет следующие методы:
- setText(element: HTMLElement, value: unknown): void - устанавливает текстовое содержимое элемента
- setDisabled(element: HTMLElement, state: boolean): void - изменяет статус блокировки элемента
- setImage(element: HTMLImageElement, src: string, alt?: string): void - устанавливает изображение с альтернативным текстом
- render(data?: Partial<T>): HTMLElement - сохраняет полученные в параметре данные в полях компонента через его сеттеры, возвращает обновленный контейнер компонента.

#### Класс Page
Расширяет класс Component для типа данных IPage. Предназначен для отображения главного экрана приложения с каталогом товаров. Конструктор принимает элемент разметки и экземпляр класса EventEmitter для возможности инициации событий, а также устанавливает слушатель на кнопку с иконкой корзины.
- constructor(container: HTMLElement, events: IEvents) \
Поля класса:
- gallery: HTMLElement - элемент разметки для отображения списка карточек товаров
- buttonElement: HTMLButtonElement - элемент разметки для отображения иконки корзины, при клике по которой происходит открытие модального окна с корзиной покупок
- basketCounter: HTMLElement - элемент разметки для отображения количества товаров, находящихся в корзине.\
Класс также имеет свойства catalog и counter, которые устанавливаются через сеттер, принимая в параметры типы HTMLElement[] и number соответственно. 

#### Класс Card
Расширяет класс Component для типа данных IItem. Класс предназначен для отображения карточки товара в различных вариантах верстки в зависимости от темплейта. В конструктор принимает HTMLElement, созданный из темплейта карточки товара, экземпляр класса EventEmitter для возможности инициации событий и опционально функцию-обработчик для генерации или обработки событий в карточке товара:
- constructor(container: HTMLElement, events: IEvents, actions?: ICardActions), interface ICardActions {onClick: (event: MouseEvent) => void} \
Поля класса содержат элементы разметки элементов карточки:
- imageElement?: HTMLImageElement - элемент разметки с изображением товара
- categoryElement?: HTMLElement - элемент разметки для отображения категории товара
- titleElement: HTMLElement - элемент разметки для отображения названия товара
- textElement?: HTMLElement - элемент разметки для отображения описания товара
- priceElement: HTMLElement - элемент разметки для отображения цены товара
- indexElement? : HTMLElement - элемент разметки для отображения номера товара в списке товаров 
- buttonElement? : HTMLButtonElement - элемент разметки для отображения ryjgrb\
Также у класса есть свойства 
- id: value: string
- description?: string
- image?: string
- title: string
- category?: string
- price: number
- isInBasket: boolean
- index: number, \
которые устанавливаются через сеттеры.\
В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.

#### Класс Modal
Класс расширяет класс Component для типа данных IModalData. Реализует отображение модального окна. Так же предоставляет методы open и close для управления отображением модального окна. Конструктор принимает элемент разметки модального окна и экземпляр класса EventEmitter для возможности инициации событий, а также устанавливает слушатели на клик в оверлей и кнопку-крестик для закрытия попапа:
- constructor(container: HTMLElement, events: IEvents) \
Поля класса:
- closeButton: HTMLButtonElement - кнопка закрытия окна
- contentElement: HTMLElement - элемент разметки, являющийся контейнером для содержимого модального окна\
Класс также имеет свойство content, которое устанавливается через сеттер, принимая в параметры HTMLElement.\
Методы:
- open(): void - открывает модальное окно
- close(): void - закрывает модальное окно при клике на оверлей или кнопке-крестику
- render(data: IModalData): HTMLElement - переопределяет метод render, возвращая готовый элемент разметки модального окна с примененным к нему методом open.

#### Класс Basket
Расширяет класс Component для типа данных IBasketView. Предназначен для отображения корзины покупок. Конструктор принимает HTMLElement и экземпляр класса EventEmitter для возможности инициации событий, а также устанавливает слушатель на клик по кнопке, который инициирует открытие модального окна для заполнения информации о доставке и оплате:
- constructor(container: HTMLElement, events: IEvents)\
Поля класса:
- basketList: HTMLElement - элемент разметки для отображения списка карточек товаров
- totalElement: HTMLElement - элемент разметки для отображения общей стоимости товаров в корзине
- buttonElenent: HTMLButtonElement - кнопка подтверждения \
Класс также имеет свойства items и total, которые устанавливаются через сеттер, принимая в параметры типы HTMLElement[] и number соответственно.

#### Класс Form
Расширяет класс Component для типа данных IFormState. Предназначен для отображения формы, содержащей поля ввода. Конструктор принимает HTMLFormElement и экземпляр класса EventEmitter для возможности инициации событий, а также устанавливает слушатели на изменения полей ввода и на сабмит формы. 
- constructor(container: HTMLElement, events: IEvents)
При сабмите инициирует событие, передавая в него объект с данными из полей ввода формы. При изменении данных в полях ввода инициирует событие изменения данных.\
Поля класса:
- inputElements: HTMLInputElement[] - массив полей ввода
- submitButtonElement: HTMLButtonElement - кнопка подтверждения
- errorElement: HTMLElement - элемент разметки для вывода ошибок под полями формы\
Также класс имеет свойства errors и valid, которые устанавливаются через сеттер, принимая в параметры данные типа string и boolean соответственно.\
Родительский метод render принимает в параметрах данные типа Partial<T> & IFormState (например, для рендера формы заполнения контактных данных пользователя будут передаваться данные типа IContacts & IFormState).
Класс является дженериком и родителем для компонентов, являющихся формами в данном приложении.

#### Класс OrderForm
Расширяет класс Form для типа данных IDeliveryInfo. Предназначен для реализации формы для заполнения информации о доставке и оплате. Конструктор принимает HTMLFormElement и экземпляр класса EventEmitter для возможности инициации событий. 
- constructor(container: HTMLElement, events: IEvents)\
Так как способ оплаты выбирается с помощью кнопок, то конструктор дополнительно устанавливает слушатели на кнопки выбора способа оплаты, при клике на которые генерируется событие `payMethod:select`. \
Поля класса:
- payMethodButtonElements: HTMLButtonElement[] - массив кнопок для выбора способа оплаты\
Также класс имеет свойства address и payment, которые устанавливаются через сеттеры и принимают в параметры данные типа string.

#### Класс ContactsForm
Расширяет класс Form для типа данных IContacts. Предназначен для реализации формы для заполнения контактных данных покупателя. Конструктор принимает HTMLFormElement и экземпляр класса EventEmitter для возможности инициации событий. 
- constructor(container: HTMLElement, events: IEvents)\
Класс имеет свойства address и payment, которые устанавливаются через сеттеры и принимают в параметры данные типа string.

#### Класс OrderSuccess
Расширяет класс Component для типа данных ISuccess. Предназначен для отображения информации в случае успешного оформления заказа. Принимает в конструктор HTMLElement и экземпляр класса EventEmitter для возможности инициации событий:
- constructor(container: HTMLElement,  events: IEvents) \
Поля класса:
- totalElement: HTMLElement - элемент разметки для отображения общей стоимости купленных товаров
- button: HTMLButtonElement - кнопка закрытия окна \
Класс также имеет свойство total, которое устанавливается через сеттер, принимая в параметры тип number.

### Слой коммуникации

#### Класс AppApi
Расширяет класс Api. Реализует взаимодействие с бэкендом сервиса. В конструктор принимает дополительно параметр cdn, который является полем класса:
- constructor(cdn: string, baseUrl: string, options?: RequestInit) \
Mетоды: 
getCatalog(): Promise<IItem[]> - получение каталога товаров 
sendOrder(order: IOrder): Promise<IOrderResult> - отправка информации о товаре на сервер

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий, генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.


*Список всех событий, которые могут генерироваться в системе:*
*События изменения данных (генерируются классами моделями данных)*
- `items:changed` - изменение массива товаров (следует обновить каталог товаров на главном экране); событие генерируется при вызове метода setCatalog при инициализации приложения
- `preview:changed` - изменение id товара, выбранного для просмотра в модальном окне (следует открыть модальное окно для просмотра товара); событие генерируется при вызове метода setPreview по клику карточки товара в каталоге
- `basket:changed` - изменение массива товаров в корзине (следует обновить отображение счетчика на главном экране и отображение информации в модальном окне корзины покупок); событие генерируется при вызове методов addBasketItem,deleteBasketItem и clearOrderInfo при клике по кнопке в модальном окне просмотра товара и при клике на иконку удаления товара в корзине, а также при успешном оформлении заказа
- `order:validation` - событие, сообщающее о необходимости валидации формы с информацией о доставке и оплате
- `deliveryInfo:ready` - успешное заполнение информации о доставке и оплате (кнопка "Далее" в соответствующей форме должна стать доступной); событие генерируется при вызове метода validateDeliveryInfo (внутри метода setDeliveryFormField после клика по кнопке модального окна с информацией о доставке и оплате) в случае успешной валидации формы
- `contacts:validation`- событие, сообщающее о необходимости валидации формы с контактными данными пользователя
- `contacts:ready` - успешное заполнение контактных данных покупателя (кнопка "Далее" в соответствующей форме должна стать доступной)
- `order:send` -  информацию о заказе успешно отправлена на сервер, следует отобразить информацию об успешном оформлении заказа и щчистить данные о заказе (корзину покупок и информацию о покупателе)

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `item:select` - выбор товара для отображения в модальном окне (событие генерируется при клике карточки товара в каталоге на главной странице) - в результате id товара сохраняется в поле preview модели данных
- `basket:open` - открытие модального окна с отображением корзины (событие генерируется при клике по иконке корзины на главном экране) - следует отобразить модальное окно корзины покупок
- `basket:addItem`- выбор товара для добавления в корзину (событие генерируется при клике по кнопке "В корзину" в окне просмотра карточки товара) - к массиву в поле basket модели данных добавляется id выбранного товара, при этом изменяется текст кнопки в модальном окне просмотра товара
- `basket:deleteItem` - выбор товара для удаления из корзины (событие генерируется при клике по кнопке "Убрать из корзины" в окне просмотра карточки товара или при клике по иконке удаления карточки товара в корзине) - id товара удаляется из массива поля basket модели данных, при этом изменяется текст кнопки в модальном окне просмотра товара
- `delivery:open` - открытие модального окна для оформления заказа (событие генерируется при клике по кнопке  "Оформить" в корзине покупок) - следует отобразить модальное окно для заполнения информации о доставке и оплате
- `payMethod:select` - изменение информации о способе оплаты (событие генерируется при клике по кнопке  выбора способа оплаты в соответствующей форме)
- `order-field:input` - изменение информации об адресе доставки (событие генерируется при вводе данных об адресе доставки в соответствующей форме)
- `order-form:submit` - сохранение информации о доставке и оплате (событие генерируется при клике по кнопке "Далее" в соответствующей форме) - в результате информация из полей ввода данной формы сохраняется в поле order модели данных
- `contacts-field:input`- изменение данных в форме с контактными данными пользователя (событие генерируется при вводе данных в полях соответствующей формы)
- `contacts-form:submit` - событие генерируется при клике по кнопке "Оплатить" в форме контактной информации, в результате информация о заказе отправляется на сервер
- `order:finished` - событие генерируется при клике по кнопке окна успешного оформления заказа - следует закрыть модальное окно

